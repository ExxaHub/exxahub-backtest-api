import { Interpreter } from './Interpreter'
import { Parser } from './Parser'
import { DataProvider } from './DataProvider'
import type { 
    Algorithm,
  } from "./types";
import { AlpacaStockClient } from './clients/AlpacaClient';

const algorithmJson = `{"id":"s5GErXCs6ABTzQ8EPwVB","step":"root","name":"Copy of BESTQQQ","description":"","rebalance":"daily","children":[{"id":"d05deb50-c8d9-44a4-9b9d-b8755f8ca65c","step":"wt-cash-equal","children":[{"id":"a751d88d-3ab4-49a4-9712-25f38e36217f","step":"group","name":"Part 1","children":[{"step":"wt-cash-equal","id":"b7570c99-40d6-4bd6-b272-0a8e2fa25675","children":[{"id":"b7ae3162-7925-4f3f-b4a3-f0a17ca36aba","step":"if","children":[{"children":[{"id":"69d87aaa-bf1c-47ac-a738-ec196b5b7f14","step":"wt-cash-equal","children":[{"id":"b779cb0b-17b0-4b41-8316-1a9928816165","step":"if","children":[{"children":[{"id":"29d3b1c0-b834-4661-afed-05cfe4377bd1","step":"wt-cash-equal","children":[{"id":"be35130f-14be-4709-af2d-bce74db3357e","step":"if","children":[{"children":[{"id":"bf0063e8-bc38-4710-a567-c4a1df60c42a","step":"wt-cash-equal","children":[{"ticker":"TQQQ","exchange":"XNAS","name":"ProShares UltraPro QQQ","id":"252da351-1a81-4a3b-be37-49e1e6e254e4","step":"asset"}]}],"lhs-fn-params":{"window":60},"is-else-condition?":false,"rhs-fixed-value?":true,"lhs-fn":"relative-strength-index","lhs-val":"TQQQ","id":"c817dbf4-a0b5-4700-b2aa-b4cee343787c","comparator":"lt","rhs-val":"60","step":"if-child"},{"id":"2912bf93-27e9-4bf5-a06a-c0c8ac4af68c","step":"if-child","is-else-condition?":true,"children":[{"ticker":"BIL","exchange":"ARCX","name":"SPDR Bloomberg 1-3 Month T-Bill ETF","id":"ce44f9db-6579-41da-a1dd-0d5fc7d75d4b","step":"asset"}]}]}]}],"lhs-fn-params":{"window":20},"rhs-fn":"relative-strength-index","is-else-condition?":false,"rhs-fixed-value?":false,"lhs-fn":"relative-strength-index","lhs-val":"AGG","id":"d93342c6-3803-48ac-a236-d940c77f1a32","rhs-fn-params":{"window":60},"comparator":"gt","rhs-val":"SH","step":"if-child","collapsed?":false},{"id":"3e26eb0f-4f2b-41d1-a579-1dad283b2642","step":"if-child","is-else-condition?":true,"children":[{"id":"4c87f193-1d6e-4810-8ed4-5e564d31c05d","step":"wt-cash-equal","children":[{"id":"c1ab20f9-534f-4f9d-852f-1ca65a367f0b","step":"if","children":[{"children":[{"id":"4052e20c-54fc-4de4-aba8-5266ff96ed7f","step":"wt-cash-equal","children":[{"select?":true,"children":[{"ticker":"AGG","exchange":"ARCX","name":"iShares Core U.S. Aggregate Bond ETF","id":"6f8e0ddc-4096-4847-8435-b55afb46dd10","step":"asset"},{"ticker":"TQQQ","exchange":"XNAS","name":"ProShares UltraPro QQQ","id":"b796ba1c-0f01-487f-b92b-bc8af0cb0845","step":"asset"}],"select-fn":"bottom","select-n":"1","sort-by-fn":"relative-strength-index","id":"a22e7e29-819a-456f-96ff-1b11c2ece8bb","sort-by?":true,"step":"filter","sort-by-fn-params":{"window":14}}]}],"lhs-fn-params":{},"rhs-fn":"moving-average-price","is-else-condition?":false,"rhs-fixed-value?":false,"lhs-fn":"current-price","lhs-val":"TQQQ","id":"7d80c695-ac8e-40f8-86a6-5f7469637c49","rhs-fn-params":{"window":50},"comparator":"lt","rhs-val":"TQQQ","step":"if-child"},{"id":"1edc5fac-e253-481b-b410-5849f400df8c","step":"if-child","is-else-condition?":true,"children":[{"id":"36e0e4c8-af2a-471b-b57c-c5d627e58bb4","step":"wt-cash-equal","children":[{"ticker":"BIL","exchange":"ARCX","name":"SPDR Bloomberg 1-3 Month T-Bill ETF","id":"7edd49ce-6c67-406f-b419-f67c0a492ebc","step":"asset"}]}]}]}],"collapsed?":false}],"collapsed?":false}],"collapsed?":false}]}],"lhs-fn-params":{},"rhs-fn":"moving-average-price","is-else-condition?":false,"rhs-fixed-value?":false,"lhs-fn":"current-price","lhs-val":"HYG","id":"6f55cbb8-112d-4af0-8b9d-60877da924b4","rhs-fn-params":{"window":200},"comparator":"gt","rhs-val":"HYG","step":"if-child"},{"id":"c7ebaa0f-dad4-4b12-a70f-c840685b59e5","step":"if-child","is-else-condition?":true,"children":[{"id":"0f3e9c1c-a5b7-435b-a15c-34d09867c58f","step":"wt-cash-equal","children":[{"id":"7cf2c508-31e9-4802-b447-5192a2ca35c8","step":"if","children":[{"children":[{"id":"54fe7ad9-0ae7-4ce1-bae7-8a6d959ceaf4","step":"wt-cash-equal","children":[{"id":"054cf295-a070-4815-83cc-27a76090111d","step":"if","children":[{"children":[{"id":"f09abaff-90a1-4054-8323-e1a1a587c4ba","step":"wt-cash-equal","children":[{"select?":true,"children":[{"ticker":"AGG","exchange":"ARCX","name":"iShares Core U.S. Aggregate Bond ETF","id":"f7e0562b-9f9a-48fa-b50d-2894f61525e7","step":"asset"},{"ticker":"TQQQ","exchange":"XNAS","name":"ProShares UltraPro QQQ","id":"e6739677-606f-4f16-b62b-d2e2028a1d03","step":"asset"}],"select-fn":"bottom","select-n":"1","sort-by-fn":"relative-strength-index","id":"2009f8df-1da3-4f64-afad-4f987c1e13ea","sort-by?":true,"step":"filter","sort-by-fn-params":{"window":14}}]}],"lhs-fn-params":{},"rhs-fn":"moving-average-price","is-else-condition?":false,"rhs-fixed-value?":false,"lhs-fn":"current-price","lhs-val":"TQQQ","id":"4152af4c-4e02-454e-ad4d-801975923750","rhs-fn-params":{"window":50},"comparator":"lt","rhs-val":"TQQQ","step":"if-child"},{"id":"903e5561-a449-4ecf-8124-3a846a3649a3","step":"if-child","is-else-condition?":true,"children":[{"id":"3a6af220-bd3d-4f00-8266-35d4da414782","step":"wt-cash-equal","children":[{"ticker":"BIL","exchange":"ARCX","name":"SPDR Bloomberg 1-3 Month T-Bill ETF","id":"50105cb3-5955-46eb-8842-23e2632af1ea","step":"asset"}]}]}]}]}],"is-else-condition?":false,"rhs-fixed-value?":true,"lhs-fn":"cumulative-return","lhs-window-days":"5","lhs-val":"SVXY","id":"d184ac39-7e58-45a4-b8b0-429744c14dcd","comparator":"gt","rhs-val":"0","step":"if-child","collapsed?":false},{"id":"7d5a05b2-32d7-4fbd-ad7b-2d89ebacc5d2","step":"if-child","is-else-condition?":true,"children":[{"id":"710c28b6-73c3-4fb9-ab61-82321753628c","step":"wt-cash-equal","children":[{"ticker":"BIL","exchange":"ARCX","name":"SPDR Bloomberg 1-3 Month T-Bill ETF","id":"41f36b56-0c0a-43a7-afa3-0aed259b798b","step":"asset"}]}],"collapsed?":false}]}]}]}]}]}],"collapsed?":true},{"id":"471f8fb3-5256-4295-8756-ca82a2b12939","step":"group","name":"Part 2","children":[{"step":"wt-cash-equal","id":"a2680356-7dc7-44f7-aae0-cd6ba107088b","children":[{"id":"aec30054-38e1-46e7-907a-9fc9fc3974dc","step":"if","children":[{"children":[{"id":"c6d74f27-fdc3-4df1-ab9f-9c6500443f11","step":"wt-cash-equal","children":[{"id":"0f1d474e-d19d-4f5f-ad24-fb158d7a90db","step":"if","children":[{"children":[{"id":"a259fc9f-0005-4c54-858b-184a74c68307","step":"wt-cash-equal","children":[{"id":"bb51e139-d3c6-4f8b-a684-c497a65f381f","step":"if","children":[{"children":[{"id":"0a4f41e5-7965-4870-9b62-f74b2ac8554a","step":"wt-cash-equal","children":[{"ticker":"TQQQ","exchange":"XNAS","name":"ProShares UltraPro QQQ","id":"877eb442-0b70-4ee8-aa29-9295960486b6","step":"asset"}]}],"lhs-fn-params":{},"rhs-fn":"moving-average-price","is-else-condition?":false,"rhs-fixed-value?":false,"lhs-fn":"current-price","lhs-val":"TQQQ","id":"190b1fd8-051f-44ff-b1e5-7dd97fa0d935","rhs-fn-params":{"window":20},"comparator":"gt","rhs-val":"TQQQ","step":"if-child"},{"id":"1cc6588b-56b3-489e-b686-2a85bd95a3aa","step":"if-child","is-else-condition?":true,"children":[{"id":"360a5322-afce-4a96-ba78-81373fc83def","step":"wt-cash-equal","children":[{"ticker":"BIL","exchange":"ARCX","name":"SPDR Bloomberg 1-3 Month T-Bill ETF","id":"50046ae5-a365-4cde-9b7e-7ec4e5117cd6","step":"asset"}]}]}]}]}],"lhs-fn-params":{"window":60},"is-else-condition?":false,"rhs-fixed-value?":true,"lhs-fn":"relative-strength-index","lhs-val":"TQQQ","id":"490d1f7c-63c4-4805-94b3-44c977f0fe26","comparator":"lt","rhs-val":"60","step":"if-child"},{"id":"416578b2-fdb6-4d08-99ef-ba8391727e88","step":"if-child","is-else-condition?":true,"children":[{"ticker":"BIL","exchange":"ARCX","name":"SPDR Bloomberg 1-3 Month T-Bill ETF","id":"21947b83-9e7a-4691-a07e-3f0e314c23d1","step":"asset"}]}]}]}],"lhs-fn-params":{"window":20},"rhs-fn":"relative-strength-index","is-else-condition?":false,"rhs-fixed-value?":false,"lhs-fn":"relative-strength-index","lhs-val":"AGG","id":"b3433a36-6a1d-4f4b-98f9-a8fbcb996e04","rhs-fn-params":{"window":60},"comparator":"gt","rhs-val":"SH","step":"if-child","collapsed?":false},{"id":"4ac4bbfc-225a-4838-882e-b5b92fc808ed","step":"if-child","is-else-condition?":true,"children":[{"id":"0444cc4e-9295-4728-a0f3-9b6e68854296","step":"wt-cash-equal","children":[{"id":"62a8ffd2-299e-42d8-85f0-3bb11d9306e5","step":"if","children":[{"children":[{"id":"3c511bf7-497e-4c14-9c8c-8fa1e8a723ff","step":"wt-cash-equal","children":[{"select?":true,"children":[{"ticker":"AGG","exchange":"ARCX","name":"iShares Core U.S. Aggregate Bond ETF","id":"94dac3c5-d14e-46f8-8b5d-cb161fa0a3e3","step":"asset"},{"ticker":"TQQQ","exchange":"XNAS","name":"ProShares UltraPro QQQ","id":"87a89455-c077-4958-9793-056280e1f17f","step":"asset"}],"select-fn":"bottom","select-n":"1","sort-by-fn":"relative-strength-index","id":"40dcf1ca-6c6b-4d30-ba70-76af05e39f5a","sort-by?":true,"step":"filter","sort-by-fn-params":{"window":14}}]}],"is-else-condition?":false,"rhs-fixed-value?":true,"lhs-fn":"cumulative-return","lhs-window-days":"5","lhs-val":"SVXY","id":"4e569bfc-b2ff-4e56-9537-92ac519cb1f5","comparator":"gt","rhs-val":"0","step":"if-child","collapsed?":false},{"id":"144b2fd0-3200-4418-9da8-db7c8c2112a6","step":"if-child","is-else-condition?":true,"children":[{"id":"4313b6dc-dac9-419e-9f58-284d921c5acf","step":"wt-cash-equal","children":[{"ticker":"BIL","exchange":"ARCX","name":"SPDR Bloomberg 1-3 Month T-Bill ETF","id":"67b8cab8-d638-40d2-b7c2-9e22e02d61ac","step":"asset"}]}],"collapsed?":false}]}],"collapsed?":false}],"collapsed?":false}],"collapsed?":false}]}],"collapsed?":true}]}],"asset_class":"EQUITIES"}`;

const algorithm: Algorithm = JSON.parse(algorithmJson);
const parser = new Parser()

const indicators = parser.parseIndicators(algorithm)

const alpacaClient = new AlpacaStockClient()

const dataProvider = new DataProvider(alpacaClient, indicators)
await dataProvider.load()

const interpreter = new Interpreter(dataProvider)

const allocations = interpreter.evaluate(algorithm)

console.log(allocations);
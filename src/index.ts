import { Interpreter } from './Interpreter'
import { Parser } from './Parser'
import { IndicatorCache } from './IndicatorCache'
import type { 
    Algorithm,
  } from "./types";
import { AlpacaStockClient } from './clients/AlpacaClient';
import { TiingoClient } from './clients/TiingoClient';
import { OhlcCache } from './OhlcCache';
import { Backtester } from './Backtester';

const algorithmJson = `{"description":"","children":[{"id":"70832abf-e682-47c9-bd4e-dcb8161b8f83","step":"wt-cash-equal","children":[{"weight":{"num":100,"den":100},"id":"234c9752-ac29-40ad-80ab-e69bfc2da618","step":"group","name":"10d RSI HYD > 10d RSI TNA","children":[{"step":"wt-cash-equal","id":"b3f75a15-6513-4c48-9e0e-e1293ff1009c","children":[{"id":"94406c77-3629-426a-914a-46a2ff6aa083","step":"if","children":[{"children":[{"ticker":"TQQQ","exchange":"XNAS","name":"ProShares UltraPro QQQ","id":"39544c07-8916-4b75-8dd0-6dd9c0fe3d5f","step":"asset","collapsed?":true,"children":[]}],"lhs-fn-params":{"window":10},"rhs-fn":"relative-strength-index","is-else-condition?":false,"lhs-fn":"relative-strength-index","lhs-val":"HYD","id":"1e91abda-d43b-45b6-84b1-de83aefafede","rhs-fn-params":{"window":10},"comparator":"gt","rhs-val":"TNA","step":"if-child","collapsed?":true},{"id":"712cf253-13d6-4f78-a383-b9099f2b46b1","step":"if-child","is-else-condition?":true,"children":[{"ticker":"SQQQ","exchange":"XNAS","name":"ProShares UltraPro Short QQQ","id":"97649799-e29c-4f5d-afd1-4b98ffacc677","step":"asset","collapsed?":true,"children":[]}],"collapsed?":true}],"collapsed?":true}],"collapsed?":true}],"collapsed?":true},{"weight":{"num":100,"den":100},"id":"2ec0cefa-ea78-4d3b-972d-54126e06a76b","step":"group","name":"10d RSI HYD > 10d RSI URTY","children":[{"step":"wt-cash-equal","id":"bc382b80-f00d-4fb6-a1d9-dfe7499aa2d7","children":[{"id":"4b6a9e0b-7911-4a2f-ac09-06eb93549adc","step":"if","children":[{"children":[{"ticker":"TQQQ","exchange":"XNAS","name":"ProShares UltraPro QQQ","id":"8a74e916-8b43-4c15-8f32-193423b81f29","step":"asset","collapsed?":true,"children":[]}],"lhs-fn-params":{"window":10},"rhs-fn":"relative-strength-index","is-else-condition?":false,"lhs-fn":"relative-strength-index","lhs-val":"HYD","id":"60ff066f-ed22-4689-bfe7-14eacec8d863","rhs-fn-params":{"window":10},"comparator":"gt","rhs-val":"URTY","step":"if-child","collapsed?":true},{"id":"5b970514-f5c9-42ff-81f1-e40b38b063c0","step":"if-child","is-else-condition?":true,"children":[{"ticker":"SQQQ","exchange":"XNAS","name":"ProShares UltraPro Short QQQ","id":"adda0377-46c4-412b-ac53-b5efb593ff8b","step":"asset","collapsed?":true,"children":[]}],"collapsed?":true}],"collapsed?":true}],"collapsed?":true}],"collapsed?":true},{"weight":{"num":100,"den":100},"id":"2e1fbab0-c4af-46c0-b649-1e9ad0a55698","step":"group","name":"10d RSI HYD > 10d RSI SPHB","children":[{"step":"wt-cash-equal","id":"e7d7fc56-0cf4-470f-aaa4-e613608756d7","children":[{"id":"70b1318e-db5a-44f4-a9f8-14b49af1abd4","step":"if","children":[{"children":[{"ticker":"TQQQ","exchange":"XNAS","name":"ProShares UltraPro QQQ","id":"25f0eccd-57bd-46fe-95f9-29b57ba96d38","step":"asset","collapsed?":true,"children":[]}],"lhs-fn-params":{"window":10},"rhs-fn":"relative-strength-index","is-else-condition?":false,"lhs-fn":"relative-strength-index","lhs-val":"HYD","id":"4e6d17c8-b939-4e4b-8f58-c095ca9f8b71","rhs-fn-params":{"window":10},"comparator":"gt","rhs-val":"SPHB","step":"if-child","collapsed?":true},{"id":"6ef20181-3859-48e7-b754-498e9d90c200","step":"if-child","is-else-condition?":true,"children":[{"ticker":"SQQQ","exchange":"XNAS","name":"ProShares UltraPro Short QQQ","id":"56a59bfc-71ee-4211-8261-746f97d52f86","step":"asset","collapsed?":true,"children":[]}],"collapsed?":true}],"collapsed?":true}],"collapsed?":true}],"collapsed?":true},{"weight":{"num":100,"den":100},"id":"3ca6d34d-a312-45ed-9a9f-8bd27f9abe5b","step":"group","name":"10d RSI HYD > 10d RSI XME","children":[{"step":"wt-cash-equal","id":"4510fdf0-00cc-4ed8-a815-211de3ee3811","children":[{"id":"3b2a171e-fa04-4239-920d-906fc7857b92","step":"if","children":[{"children":[{"ticker":"TQQQ","exchange":"XNAS","name":"ProShares UltraPro QQQ","id":"cd621c97-09b6-4acd-b714-82ec936e0c78","step":"asset","collapsed?":true,"children":[]}],"lhs-fn-params":{"window":10},"rhs-fn":"relative-strength-index","is-else-condition?":false,"lhs-fn":"relative-strength-index","lhs-val":"HYD","id":"4a62943e-181d-4117-9d8e-d319b9af00ab","rhs-fn-params":{"window":10},"comparator":"gt","rhs-val":"XME","step":"if-child","collapsed?":true},{"id":"f4872158-3111-4cc5-97fc-2ed54e6862a5","step":"if-child","is-else-condition?":true,"children":[{"ticker":"SQQQ","exchange":"XNAS","name":"ProShares UltraPro Short QQQ","id":"23db77a9-c2a8-4266-b4d5-775a1bc6485a","step":"asset","collapsed?":true,"children":[]}],"collapsed?":true}],"collapsed?":true}],"collapsed?":true}],"collapsed?":true},{"weight":{"num":100,"den":100},"id":"d9bf9b7e-29f8-4ac6-aae3-ef06deae53e8","step":"group","name":"10d RSI HYD > 10d RSI SCHD","children":[{"step":"wt-cash-equal","id":"785028c4-3bac-45bd-bf1b-7acbb146f326","children":[{"id":"e77ec22a-08ee-4d76-8a26-15701b4304b1","step":"if","children":[{"children":[{"ticker":"TQQQ","exchange":"XNAS","name":"ProShares UltraPro QQQ","id":"8bb54158-0977-42c5-a7d7-c392bfad7119","step":"asset","collapsed?":true,"children":[]}],"lhs-fn-params":{"window":10},"rhs-fn":"relative-strength-index","is-else-condition?":false,"lhs-fn":"relative-strength-index","lhs-val":"HYD","id":"792c70dc-3f4c-4de4-ab6b-a6aa688951f2","rhs-fn-params":{"window":10},"comparator":"gt","rhs-val":"SCHD","step":"if-child","collapsed?":true},{"id":"2484ff6f-e5e3-4859-8186-ef84a14de168","step":"if-child","is-else-condition?":true,"children":[{"ticker":"SQQQ","exchange":"XNAS","name":"ProShares UltraPro Short QQQ","id":"3f7ab2f3-2560-4e5e-9417-edad265daefb","step":"asset","collapsed?":true,"children":[]}],"collapsed?":true}],"collapsed?":true}],"collapsed?":true}],"collapsed?":true},{"weight":{"num":100,"den":100},"id":"4fdbbdc6-3e5b-40fd-8809-9344d74f8a51","step":"group","name":"10d RSI HYD > 10d RSI PXI","children":[{"step":"wt-cash-equal","id":"6c1ba46c-ef94-48ef-99f0-664bd50f5b7e","children":[{"id":"837286de-f5a5-4a98-98a2-786bbbfa364b","step":"if","children":[{"children":[{"ticker":"TQQQ","exchange":"XNAS","name":"ProShares UltraPro QQQ","id":"54117175-646e-4c24-a449-7d67840db2fc","step":"asset","collapsed?":true,"children":[]}],"lhs-fn-params":{"window":10},"rhs-fn":"relative-strength-index","is-else-condition?":false,"lhs-fn":"relative-strength-index","lhs-val":"HYD","id":"d51f006a-b28d-4960-906b-edf2f839113e","rhs-fn-params":{"window":10},"comparator":"gt","rhs-val":"PXI","step":"if-child","collapsed?":true},{"id":"587e120b-9bd6-4537-9523-591abfe7800c","step":"if-child","is-else-condition?":true,"children":[{"ticker":"SQQQ","exchange":"XNAS","name":"ProShares UltraPro Short QQQ","id":"dca2a2b0-4b5c-40d3-8053-cbada63d0e83","step":"asset","collapsed?":true,"children":[]}],"collapsed?":true}],"collapsed?":true}],"collapsed?":true}],"collapsed?":true},{"weight":{"num":100,"den":100},"id":"8643181e-b0b6-4b0e-8f3a-046192ef3fbc","step":"group","name":"10d RSI HYD > 10d RSI VAW","children":[{"step":"wt-cash-equal","id":"109610fc-bab1-4399-b822-9eb9e9b5f63a","children":[{"id":"549c28ba-446b-47f7-8dfc-592c5b05fa47","step":"if","children":[{"children":[{"ticker":"TQQQ","exchange":"XNAS","name":"ProShares UltraPro QQQ","id":"6fb6e11e-4ad2-4464-9b0e-2ecbd91d3acd","step":"asset","collapsed?":true,"children":[]}],"lhs-fn-params":{"window":10},"rhs-fn":"relative-strength-index","is-else-condition?":false,"lhs-fn":"relative-strength-index","lhs-val":"HYD","id":"5ac97030-da41-4bd2-bfeb-8da1d2408795","rhs-fn-params":{"window":10},"comparator":"gt","rhs-val":"VAW","step":"if-child","collapsed?":true},{"id":"96b8ee9c-05d8-4447-90bf-d16dc03bb603","step":"if-child","is-else-condition?":true,"children":[{"ticker":"SQQQ","exchange":"XNAS","name":"ProShares UltraPro Short QQQ","id":"3aa7757d-ad29-4640-9dd4-6bd916f028b1","step":"asset","collapsed?":true,"children":[]}],"collapsed?":true}],"collapsed?":true}],"collapsed?":true}],"collapsed?":true},{"weight":{"num":100,"den":100},"id":"86f2fb0d-3a3b-4222-a066-c160f64e3534","step":"group","name":"10d RSI HYD > 10d RSI ODFL","children":[{"step":"wt-cash-equal","id":"3fed9c0e-5177-4346-8df9-476c89075ec6","children":[{"id":"a2eed409-5100-49cd-a36e-bea195998652","step":"if","children":[{"children":[{"ticker":"TQQQ","exchange":"XNAS","name":"ProShares UltraPro QQQ","id":"3b1601cc-4c51-402e-b551-3fb0acdacd24","step":"asset","collapsed?":true,"children":[]}],"lhs-fn-params":{"window":10},"rhs-fn":"relative-strength-index","is-else-condition?":false,"lhs-fn":"relative-strength-index","lhs-val":"HYD","id":"59e366a3-70b0-4f32-9627-6ac17afed0b2","rhs-fn-params":{"window":10},"comparator":"gt","rhs-val":"ODFL","step":"if-child","collapsed?":true},{"id":"f2a284ed-4e76-4ff8-a8ce-fd7731813e7c","step":"if-child","is-else-condition?":true,"children":[{"ticker":"SQQQ","exchange":"XNAS","name":"ProShares UltraPro Short QQQ","id":"16b87fea-ec20-4786-823c-9a8bf28f3b11","step":"asset","collapsed?":true,"children":[]}],"collapsed?":true}],"collapsed?":true}],"collapsed?":true}],"collapsed?":true}]}],"name":"CodeBreaker (HYD Signals)","asset_class":"EQUITIES","rebalance":"daily","id":"Pwdj5IrRgutOyQQ594kn","step":"root"}`;

const algorithm: Algorithm = JSON.parse(algorithmJson);
const parser = new Parser()

const { assets, indicators } = parser.parse(algorithm)

const alpacaClient = new AlpacaStockClient()
const tiingoClient = new TiingoClient()

// const ohlcCache = new OhlcCache(alpacaClient, assets)
// await ohlcCache.load()

// const indicatorCache = new IndicatorCache(ohlcCache, indicators)
// await indicatorCache.load()

// const interpreter = new Interpreter(indicatorCache)

// const allocations = interpreter.evaluate(algorithm)

// console.log(allocations);

const backtester = new Backtester(algorithm, tiingoClient)
await backtester.run()